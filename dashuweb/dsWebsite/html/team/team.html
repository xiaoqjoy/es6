<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="../../files/css/bootstrap.css">
    <link rel="stylesheet" href="../../files/css/font-awesome.min.css">
    <link rel="stylesheet" href="../../files/css/simple-line-icons.css">
    <link rel="stylesheet" href="../../files/css/app.css">
    <link rel="stylesheet" href="../../files/css/paltstyle.css">
    <title>Title</title>
</head>
<body style="background: none;">
	<div class="widget-box teamBox">
		<div class="widget-title">
			<span class="icon"><i class="glyphicon glyphicon-th"></i></span>
			<h5>管理团队-详情编辑</h5>
		</div>
		<div class="widget-content ">
			<div class="content">
				<label>概述：(请输入不超过100个字)</label>
				<input type="hidden" id="sno">
				<div class="text panel" id="text_panel">
					<!-- <p>原平安银行总行零售总监，原深圳发展银行总行零售银行代理条线长</p>
					<p>原广东南粤银行总行副行长</p> -->
				</div>
				<button class="btn btn-info edit-btn" id="btn">编辑</button>
			</div>

			<div class="edit-profile" style="display: none;">
				<div>
					<iframe src="../../wysiwyg.html" id="content" frameborder="0" width="1000px" height="400px"></iframe>
				</div>
				<button class="save-btn btn btn-info">保存</button>
			</div>
		</div>
		<div class="widget-content ">
			<div class="operation text-right">
				<button id="addBtn" class="btn btn-info pull-right" onclick="editFun()">增加</button>
				<div class="clearfix"></div>
			</div>
			<table class="table data-table table-bordered team-table">
				<thead>
					<tr>
						<th>头像</th>
						<th style="width: 80px;">姓名</th>
						<th style="width: 80px;">职称</th>
						<th style="min-width: 140px;">经验</th>						
						<th style="min-width: 140px;">历任</th>
						<th style="min-width: 140px;">毕业</th>
						<th style="width: 80px;">排序号</th>
						<th style="width: 80px;">排序操作</th>
						<th style="width: 120px;">操作</th>
					</tr>
				</thead>
				<tbody id="tbody">
					<!-- <tr>
						<td><img src="../../dsWebsite/files/images/team/liubo.png" class="leader-img"></td>
						<td><span class="leader-name">柳博</span></td>
						<td><span class="titles">董事长&总裁</span></td>
						<td><div class="experience">
								<p class="experience1">原平安银行总行零售总监，原深圳发展银行总行零售银行代理条线长</p>
								<p class="experience2">原广东南粤银行总行副行长</p>
							</div></td>
						<td><span class="introduce">
								国内知名个人信贷专家，10年中国个人信贷管理经验，近10年美国个人信贷管理经验，中国个人贷款行业多项创新业务和产品的出品人，包括：双周供、同名加转按、气球贷、点按揭、信用速贷、灵活定存、蓄利宝、按揭信用卡等。原深圳发展银行、平安银行个人贷款业务的最高管理者。2011年负责深圳发展银行零售银行、2012年负责整合后的平安银行基础零售银行，包括产品管理、大众零售与贷款、营销与服务等总行一级部门。回国前就职于美国最大的按揭贷款公司之一AMERIQUEST，负责总部运营中心的业务流程设计与优化。
						</span></td>
						<td><span class="successive">广东南粤银行副行长，平安银行总行零售总监，深圳发展银行零售银行代理条线长，美国AMERIQUEST公司运营中心持续改进部主管。</span></td>
						<td><span class="graduated">美国University of Nebraska – Lincoln 金融MBA，航天部771所 硕士，浙江大学 学士</span></td>
						<td><span class="sort-num">1</span></td>
						<td>
							<a class="sort-up sort  disable " href="javascript:void(0)" onclick="sortUp(this)">
								<i class="glyphicon glyphicon-arrow-up"></i>
						    </a> 
						    <a class="sort-down sort " href="javascript:void(0)" onclick="sortDown(this)">
						    	<i class="glyphicon glyphicon-arrow-down"></i>
						    </a>
						</td>
						<td>
							<input type="hidden" class="cno">
							<a href="javascript:void(0)" onclick="editFun(this)">编辑</a>
							<a href="javascript:void(0)" onclick="deleteFun(this)">删除</a>
						</td>
					</tr> -->
				</tbody>
			</table>


		</div>

		<div class="layui-layer-shade" id="layui-layer-shade-alert" times="1" style="display: none; z-index: 14; background-color: #000; opacity: 0.3; filter: alpha(opacity = 30);"></div>
		<div class="layui-layer layui-anim layui-layer-page " id="layui-layer-alert" type="page" style="display: none; z-index: 15; width: 940px; height: 500px; left: 50%; top: 50%; margin-left: -470px; margin-top: -250px; overflow-y: auto;">
			<div class="form-horizontal edit-block">
				<div class="input-groups">
					<label>图片：</label>
					<div>
						<img src="" class="edit-block-img" id="image">
						<div class="operation ">
							<button id="uploadBtn" class="btn btn-info pull-right">上传</button>
							<form id="tf">
							<div class="file-panel">
								<input id="bannerInput" type="text" class="file-input" disabled placeholder="选择图片（图片宽度为150px,后缀jpg格式）">
								<div class="file-box">
									<input type="file" class="file" id="files" name="image" onchange="fileChange(this)">
								</div>
							</div>
							</form>
						</div>
					</div>
				</div>
				<div class="input-groups">
					<label>姓名：</label> <input type="text" maxlength="5" placeholder="请输入不超过5个字" class="leader-name-input">
				</div>
				<div class="input-groups">
					<label>职称：</label> <input type="text" maxlength="20" placeholder="请输入不超过20个字" class="titles-input">
				</div>
				<div class="input-groups">
					<label>经验1：</label> <input type="text" maxlength="50" placeholder="请输入不超过50个字" class="experience-input1">
				</div>
				<div class="input-groups">
					<label>经验2：</label> <input type="text" maxlength="50" placeholder="请输入不超过50个字" class="experience-input2">
				</div>
				<div class="input-groups">
					<label>简介：</label>
					<textarea class="introduce-input"></textarea>
				</div>
				<div class="input-groups">
					<label>历任：</label> <input type="text" class="successive-input">
				</div>
				<div class="input-groups">
					<label>毕业于：</label> <input type="text" maxlength="110" placeholder="请输入不超过110个字" class="graduated-input">
				</div>
				<div class="input-groups">
					<input type="hidden" class="cno_input">
				</div>
				<div class="input-groups btns">
					<button id="confirm-btn" class="btn btn-info pull-right" onclick="saveData()">提交</button>
					 <button id="close-btn" onclick="closeDiv()" class="btn btn-default pull-right">关闭</button>
				</div>
			</div>
		</div>
	</div>

<script src="../../files/js/jquery.min.js"></script>
<script src="../../files/js/bootstrap.js"></script>
<script src="../../files/layer/layer.js"></script>
<script src="../../files/js/comment.js"></script>
<script>
	//初始化加载
	$(function(){
		loadIntroduce();
		loadContent();
	});

	//
	$(document).on('click','.eb',function(){
		//alert(1);
		$('.edit-block .edit-block-img').attr('src', $(this).parents('tr').find('img.leader-img').attr('src'));
		$('.edit-block .leader-name-input').val($(this).parents('tr').find('.leader-name').text());
		$('.edit-block .titles-input').val($(this).parents('tr').find('.titles').text());
		$('.edit-block .experience-input1').val($(this).parents('tr').find('.experience1').text());
		$('.edit-block .experience-input2').val($(this).parents('tr').find('.experience2').text());
		$('.edit-block .introduce-input').val($(this).parents('tr').find('.introduce').text());
		$('.edit-block .successive-input').val($(this).parents('tr').find('.successive').text());
		$('.edit-block .graduated-input').val($(this).parents('tr').find('.graduated').text());
		$('.edit-block .cno_input').val($(this).parents('tr').find('.cno').val());
		$('#layui-layer-shade-alert').show();
		$('#layui-layer-alert').show();
	});
	
	function editFun() {
		//alert(2);
		$('.edit-block .edit-block-img').attr('src','');
		$('.edit-block .leader-name-input').val('');
		$('.edit-block .titles-input').val('');
		$('.edit-block .experience-input1').val('');
		$('.edit-block .experience-input2').val('');
		$('.edit-block .introduce-input').val('');
		$('.edit-block .successive-input').val('');
		$('.edit-block .graduated-input').val('');
		$('#bannerInput').val('选择图片（图片宽度为150px,后缀jpg格式）');
		$('.edit-block .cno_input').val('');
		$('#layui-layer-shade-alert').show();
		$('#layui-layer-alert').show();
	}
	 function closeDiv(){
	      	$('#layui-layer-shade-alert').hide();
	      	$('#layui-layer-alert').hide();
	 }
	function saveData(){
		var leaderImg = $('.edit-block .edit-block-img').attr('src');
		var leaderName = $('.edit-block .leader-name-input').val();
		var titles = $('.edit-block .titles-input').val();
		var experienceOne = $('.edit-block .experience-input1').val();
		var experienceTwo = $('.edit-block .experience-input2').val();
		var introduce = $('.edit-block .introduce-input').val();
		var successive = $('.edit-block .successive-input').val();
		var graduated = $('.edit-block .graduated-input').val();
		var cSerailNo = $('.cno_input').val();
		if(isEmpty(leaderImg)){
			layer.msg("请上传图片！");
			return false;
		}
		if(isEmpty(leaderImg)){
			layer.msg("请上传图片！");
			return false;
		}
		if(isEmpty(leaderName)){
			layer.msg("请输入姓名！");
			return false;
		}
		if(isEmpty(titles)){
			layer.msg("请输入职称！");
			return false;
		}
		
		if(isEmpty(introduce)){
			layer.msg("请输入简介！");
			return false;
		}	
	 
		if(isEmpty(graduated)){
			layer.msg("请输入毕业学校！");
			return false;
		}
		//alert(cSerailNo);
		var pos ={'status' : '2', 'leaderImg' : leaderImg, 'leaderName' : leaderName, 'titles' : titles, 'experienceOne' : experienceOne, 'experienceTwo' : experienceTwo, 'introduce' : introduce, 'successive' : successive, 'graduated' : graduated};
		if (!isEmpty(cSerailNo)) {
			cUpData(pos, cSerailNo);
		} else {
			cAddData(pos);
		} 
	}
	function loadContent(){
		$.ajax({
			type : "POST",
			url : "/api/DsWebsit/getDatas.do",
			data : {
				type : "team.content",
				page : "0",
				size : "999"
			},
			dataType : "json",
			success : function(jsonResult) {
				//debugger;
				if (jsonResult.code == "0000" && jsonResult.data.length>0) {
					$("#tbody").empty();
					$.each(jsonResult.data, function(i,val){
						//$(".introduce-input").text(val.introduce);
						var body = '<tr><td><img src="' + val.leaderImg + '" class="leader-img"></td>' + 
								   '<td><span class="leader-name">' + val.leaderName + '</span></td>' +
								   '<td><span class="titles">' + val.titles + '</span></td>' +
								   '<td><div class="experience">' + 
								   '<p class="experience1">' + val.experienceOne + '</p>' + 
								   '<p class="experience2">' + val.experienceTwo + '</p></div></td>' + 								  
								   '<td><span class="successive">' + val.successive + '</span></td>' + 
								   '<td><span class="graduated">' + val.graduated + '</span></td>' + 
								   '<td><span class="sort-num">' + val.sortIndex + '</span><span class="introduce" style="display:none;">' + val.introduce + '</span></td>';
						if(i==0){
							body += '<td><a class="sort-up sort  disable " href="javascript:void(0)"><i class="glyphicon glyphicon-arrow-up"></i></a>';
							body += '<a class="sort-down sort " href="javascript:void(0)"><i class="glyphicon glyphicon-arrow-down"></i></a>';
	        			}
	        			else if(i>0 && i==jsonResult.data.length-1){
	        				body += '<td><a class="sort-up sort" href="javascript:void(0)"><i class="glyphicon glyphicon-arrow-up"></i></a>';
	        				body += '<a class="sort-down sort disable" href="javascript:void(0)"><i class="glyphicon glyphicon-arrow-down"></i></a>';
	        			}else{
	        				body += '<td><a class="sort-up sort" href="javascript:void(0)"><i class="glyphicon glyphicon-arrow-up"></i></a>';
	        				body += '<a class="sort-down sort" href="javascript:void(0)"><i class="glyphicon glyphicon-arrow-down"></i></a>';
	        			}
						body += '<td><input type="hidden" class="cno" value="' + val.baseNo + '"><a class="edit-btn eb" href="javascript:void(0)">编辑</a><a class="delete-btn" href="javascript:void(0)" onclick="deleteFun(this)">删除</a></td> </tr>';	        			
	        			$("#tbody").append(body);
					});
				} 
			},
			error : function(XMLHttpRequest, textStatus, errorThrown) {
				layer.msg("系统异常，请稍后再试！");
			}
		});
	}
	
	//删除
	function deleteFun(othis) {
		var serailNo = $(othis).parents('tr').find('.cno').val();
		layer.confirm('确定删除吗？', {
			btn : [ 'Y', 'N' ]
		}, function() {
			$.ajax({  
		        type: "POST",  
		        url: "/api/DsWebsit/delData.do",  
		        data:{
		        	type : "team.content",
		        	serailNo : serailNo
		        },
		        dataType: "json",
		        success: function (jsonResult) {
	        		layer.msg(jsonResult.message);
	        		loadContent();
		        },
		        error: function(XMLHttpRequest, textStatus, errorThrown) {
					layer.msg("系统异常，请稍后再试！");
	            }
		    });   
		})
	}

	
	$(document).on('click','.sort-down',function(){
		if($(this).hasClass('disable')){
            return ;
        }else{
        	var onNum = $(this).parents('tr').find('.cno').val();     
            setSorting(onNum,"down");
        }
	});
	
	$(document).on('click','.sort-up',function(){
		if($(this).hasClass('disable')){
            return ;
        }else{
            var onNum = $(this).parents('tr').find('.cno').val();
            setSorting(onNum,"up");
        }
	});
	

	function setSorting(sSerialNo, flag) {
		$.ajax({
			type : "POST",
			url : "/api/DsWebsit/sortData.do",
			dataType : "json",
			data : {
				type : 'team.content',
				serailNo : sSerialNo,
				flag : flag
			},
			success : function(jsonResult) {
				layer.msg(jsonResult.message);
				loadContent();
			},
			error: function(XMLHttpRequest, textStatus, errorThrown) {
				layer.msg("系统异常，请稍后再试！");
            }
		});
	}
	
	function cAddData(pos){
		$.ajax({
			type : "POST",
			url : "/api/DsWebsit/addData.do",
			dataType : "json",
			data : {
				"pos" : JSON.stringify(pos),
				type : 'team.content'
			},
			success : function(jsonResult) {
				layer.msg(jsonResult.message);
				//layer.close(layer.index);
				$('#layui-layer-shade-alert').hide();
				$('#layui-layer-alert').hide();
				loadContent();
			},
			error : function(XMLHttpRequest, textStatus, errorThrown) {
				layer.msg("系统异常，请稍后再试！");
			}
		});
	}
	
	function cUpData(pos, cSerailNo){
		$.ajax({
			type : "POST",
			url : "/api/DsWebsit/upData.do",
			dataType : "json",
			data : {
				"pos" : JSON.stringify(pos),
				type : 'team.content',
				serailNo : cSerailNo
			},
			success : function(jsonResult) {
				layer.msg(jsonResult.message);
				//layer.close(layer.index);
				$('#layui-layer-shade-alert').hide();
				$('#layui-layer-alert').hide();
				loadContent();
			},
			error : function(XMLHttpRequest, textStatus, errorThrown) {
				layer.msg("系统异常，请稍后再试！");
			}
		});
	}

	//上传图片
	$(document).on( 'click', '#uploadBtn', function() {
		var form = new FormData(document.getElementById("tf"));
		$.ajax({
			url : "/api/uploadImageLocal.do",
			type : "POST",
			data : form,
			processData : false, // 告诉jQuery不要去处理发送的数据
			contentType : false, // 告诉jQuery不要去设置Content-Type请求头
			success : function(jsonResult) {
				if (!isEmpty(jsonResult) && jsonResult.code == '0000') {
					$(".edit-block-img").attr("src", jsonResult.data);
				}
			},
			error : function(XMLHttpRequest, textStatus, errorThrown) {
				layer.msg("系统异常，请稍后再试！");
			}
		});
	});

	//編輯概述
	function iAddData(pos) {
		$.ajax({
			type : "POST",
			url : "/api/DsWebsit/addData.do",
			dataType : "json",
			data : {
				"pos" : JSON.stringify(pos),
				type : 'team.introduce'
			},
			success : function(jsonResult) {
				layer.msg(jsonResult.message);
				loadIntroduce();
			},
			error : function(XMLHttpRequest, textStatus, errorThrown) {
				layer.msg("系统异常，请稍后再试！");
			}
		});
	}

	function iUpData(pos, iSerailNo) {
		$.ajax({
			type : "POST",
			url : "/api/DsWebsit/upData.do",
			dataType : "json",
			data : {
				"pos" : JSON.stringify(pos),
				type : 'team.introduce',
				serailNo : iSerailNo
			},
			success : function(jsonResult) {
				layer.msg(jsonResult.message);
				loadIntroduce();
			},
			error : function(XMLHttpRequest, textStatus, errorThrown) {
				layer.msg("系统异常，请稍后再试！");
			}
		});
	}

	function loadIntroduce() {
		$.ajax({
			type : "POST",
			url : "/api/DsWebsit/getDatas.do",
			data : {
				type : "team.introduce",
				page : "0",
				size : "1"
			},
			dataType : "json",
			success : function(jsonResult) {
				if (jsonResult.code == "0000" && jsonResult.data.length == 1) {
					$("#text_panel").html(jsonResult.data[0].textDesc);
					$('#sno').val(jsonResult.data[0].baseNo);
				} else {
					$("#text_panel").html("");
					$('#sno').val('');
				}
			},
			error : function(XMLHttpRequest, textStatus, errorThrown) {
				layer.msg("系统异常，请稍后再试！");
			}
		});
	}

	$(function() {
		//编辑概述
		$('#btn').click(function() {
			$('.edit-profile').show();
			document.getElementById("content").contentWindow.document.getElementById("editor").innerHTML = $('.content .text').html();
			$('.content').hide();
		});

		$('#layui-layer-shade-alert').click(function() {
			$('#layui-layer-shade-alert').hide();
			$('#layui-layer-alert').hide();
		})
	});

	//保存概述
	$('.save-btn').click(function() {
		$('.edit-profile').hide();
		$('.content').show();
		$('.content .text').html(document.getElementById("content").contentWindow.document.getElementById('editor').innerHTML);
		content = document.getElementById("content").contentWindow.document.getElementById('editor').innerHTML;
		var str = removeHTMLTag(content);
		str = str.replace(/[\ |\~|\`|\!|\@|\#|\$|\%|\^|\&|\*|\(|\)|\-|\_|\+|\=|\||\\|\[|\]|\{|\}|\;|\:|\"|\'|\,|\<|\.|\>|\/|\?]/g,""); 
		if (str.length > 100) {
			layer.msg("请输入不超过100个字,您输入了" + str.length + "个字。");
			return;
		}
		var pos = {
			'status' : '2',
			'textDesc' : content
		};
		var iSerailNo = $('#sno').val();
		if (!isEmpty(iSerailNo)) {
			iUpData(pos, iSerailNo);
		} else {
			iAddData(pos);
		}
	});
	
	

	function removeHTMLTag(str) {
		str = str.replace(/<\/?[^>]*>/g, ''); //去除HTML tag
		str = str.replace(/[ | ]*\n/g, '\n'); //去除行尾空白
		//str = str.replace(/\n[\s| | ]*\r/g,'\n'); //去除多余空行
		str = str.replace(/&nbsp;/ig, '');//去掉&nbsp;
		return str;
	}
</script>
</body>
</html>