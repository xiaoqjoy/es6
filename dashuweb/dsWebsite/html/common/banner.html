<!DOCTYPE html>
<html lang="en">

	<head>
		<meta charset="UTF-8">
		<link rel="stylesheet" href="../../files/css/bootstrap.css">
		<link rel="stylesheet" href="../../files/css/font-awesome.min.css">
		<link rel="stylesheet" href="../../files/css/simple-line-icons.css">
		<link rel="stylesheet" href="../../files/css/app.css">
		<link rel="stylesheet" href="../../files/css/paltstyle.css">
		<title>Title</title>
	</head>

	<body style="background: none;">

		<input type="hidden" id="hidId">
		<div class="widget-box bannerBox">
			<div class="widget-title"> <span class="icon"><i class="glyphicon glyphicon-th"></i></span>
				<h5></h5>
			</div>
			<div class="widget-content ">
				<div class="operation text-right">

					<button id="create-btn" class="btn btn-info pull-right">增加</button>
					<div class="clearfix"></div>
				</div>
				<table class="table data-table table-bordered">
					<thead>
						<tr>
							<th>ID号</th>
							<th>图片</th>
							<!--<th>图片链接</th>-->
							<th>跳转模块</th>
							<th>排序号</th>
							<th style="min-width: 60px;">排序操作</th>
							<th style="min-width: 90px;">操作</th>
						</tr>
					</thead>
					<tbody id="list">

					</tbody>
				</table>

				<div class="text-right">
					<ul class="pagination pagination-sm">

					</ul>
				</div>

			</div>

		</div>

		<div class="layui-layer-shade" id="layui-layer-shade-alert" times="1" style="display: none; z-index: 14; background-color: #000; opacity: 0.3; filter: alpha(opacity = 30);"></div>
		<div class="layui-layer layui-anim layui-layer-page " id="layui-layer-alert" type="page" style="display: none; z-index: 15; width: 960px; height: 400px; left: 50%; top: 50%; margin-left: -480px; margin-top: -250px;overflow-y: auto;overflow-x: auto;">
			<div class="layui-layer-content" style="height: 380px;">

				<div class="form-horizontal">

					<div class="double-input" style="margin-top:20px">
						<div class="l input-groups">
							<label>图片：</label>
							<form id="tf">
								<div class="file-panel">
									<input id="bannerInput" type="text" class="file-input" placeholder="选择图片（图片的尺寸为：1920*500px）">
									<div class="file-box">
										<input type="file" class="file" id="files" name="image" onchange="fileChange(this)">
									</div>
								</div>
							</form>
							<input type="hidden" id="fileId">
							<button class="btn btn-info pull-left" onclick="uploadImg()">上传图片</button>
						</div>
						<div class="r input-groups">
							<label>图片预览：</label>
							<img src="" id="img" width="250px">
						</div>
					</div>

					<div class="l input-groups">
						<label>图片链接：</label>
						<input id="txtLink" type="text" class="imageLink" placeholder="请输入图片链接">
					</div>
					<div class="l input-groups jump-module">
						<label>跳转模块：</label>
						<select id="selID" onchange="selPage()">

						</select>
						<!--<select id="subID">
							<option value="" disabled selected style="display: none;">--请选择模块--</option>
						</select>-->

						<button onclick="clearBtn()">清空</button>
					</div>

					<div class="input-groups btns">
						<button id="close-btn" onclick="closeDiv()" class="btn btn-default pull-right">关闭</button>
						<button id="confirm-btn" class="btn btn-info pull-right">确认</button>
					</div>
				</div>
			</div>
			<span class="layui-layer-setwin"></span>
		</div>

		<script src="../../files/js/jquery.min.js"></script>
		<script src="../../files/js/bootstrap.js"></script>
		<script src="../../files/layer/layer.js"></script>
		<script src="../../files/js/comment.js"></script>
		<script src="../../files/js/jquery.form.js"></script>
		<script src="./moduleArr.json"></script>
		<script>
			var paramType = ""; //参数

			$(function() {
				initializeBanner();
				initializeSelect();
				getDatas();
			});

			function initializeBanner(){	//所有模块的banner使用公共页面
				var pageType = window.location.href.split("#")[1];
				var pageName = '';
				switch (pageType){
					case 'main':
						pageName = "首页";
						paramType = "main.banner";
						break;
					case 'about':
						pageName = "关于我们";
						paramType = "about.banner";
						break;
					case 'technology':
						pageName = "技术与能力";
						paramType = "technology.banner";
						break;
					case 'solution':
						pageName = "解决方案";
						paramType = "solution.banner";
						break;
					case 'service':
						pageName = "产品服务";
						paramType = "service.banner";
						break;
					case 'advantage':
						pageName = "核心优势";
						paramType = "advantage.banner";
						break;
					case 'join':
						pageName = "加入我们";
						paramType = "join.banner";
						break;
					case 'report':
						pageName = "媒体报道";
						paramType = "report.banner";
						break;
					case 'contactUs':
						pageName = "联系我们";
						paramType = "contactUs.banner";
						break;
					default :
						break;
				}
				$(".widget-title h5").text(pageName + "-banner编辑")
			}

			function initializeSelect() { //初始化级联选择框
				$("#selID").append('<option value="" disabled selected style="display: none;">--请选择页面--</option>');
				for(var i = 0; i < moduleArr.length; i++) {
					$("#selID").append("<option value='" + moduleArr[i].pageLink + "'>" + moduleArr[i].page + "</option>");
				}
			}

			function clearBtn() { //清空按钮
				$("#selID").empty().next("#subID").remove();
				initializeSelect();
			}

			function selSub() { // 子选择框点击事件
				console.log($("#subID").find("option:selected").attr("value"));
			}

			function selPage() { // 父选择框点击事件
				var index = $('#selID').get(0).selectedIndex;	//获取点的第几个
				var targetAnchor = moduleArr[index - 1].children;	//找到对应页面有哪些模块
				if(!targetAnchor) {	//如果没有子模块，清空子选择框
					$("#selID").next("#subID").remove();
					return
				};
				if(!$("#subID").get(0)) {	//如果子选择框不存在，插入子选择框
					$("<select id='subID' onchange='selSub()'></select>").insertAfter("#selID");
				}
				$("#subID").empty(); //	子选项清空
				for(var i = 0; i < targetAnchor.length; i++) {
					if(i == 0) {
						$("#subID").append("<option selected value='" + targetAnchor[i].anchorId + "'>" + targetAnchor[i].anchorName + "</option>");
					} else {
						$("#subID").append("<option value='" + targetAnchor[i].anchorId + "'>" + targetAnchor[i].anchorName + "</option>");
					}
				}
			}

			$('#confirm-btn').click(function() {
				var selVal = $("#selID").find("option:selected").attr("value"); //页面选择的值
				var subVal = $("#subID").find("option:selected").attr("value"); //模块选择的值(不知道为什么多出来一个空格)

				var id = $("#hidId").val();
				var link = $('#txtLink').val(); //图片链接
				var linkModule = !subVal ? selVal : selVal + "#" + subVal; //跳转模块
				var imgSrc = ""; //图片地址

				if(isEmpty($("#img").attr("src"))) {
					imgSrc = $("#fileId").val();
				} else {
					imgSrc = $("#img").attr("src");
				}
				var pos = {
					status: status,
					imageSrc: imgSrc,
					field1: linkModule,
					imageLink: link
				};

				console.log("要带过去的参数：", pos);

				if(isEmpty(imgSrc)) {
					layer.msg('请上传图片');
					return;
				}
				if(!isEmpty(link) && !isEmpty(linkModule)) {
					layer.msg('图片链接和跳转模块只能二选一');
					return;
				}

				var url = isEmpty(id) ? "/api/DsWebsit/addData.do" : "/api/DsWebsit/upData.do";
				$.ajax({
					type: 'post',
					dataType: 'json',
					url: url,
					data: {
						pos: JSON.stringify(pos),
						type: paramType,
						serailNo: id
					},
					success: function(rtnData) {
						layer.msg(rtnData.message);
						if(rtnData.code == "0000") {
							resetDiv();
							closeDiv();
							getDatas();
						}
					},
					error: function(XMLHttpRequest, textStatus, errorThrown) {
						layer.msg("系统异常，请稍后再试！");
					}
				});

			});

			function closeDiv() {
				$('#layui-layer-shade-alert').hide();
				$('#layui-layer-alert').hide();
			}
			$('#create-btn').click(function() {
				clearBtn();
				$('#layui-layer-shade-alert').show();
				$('#layui-layer-alert').show();
			});

			function resetDiv() {
				$("#hidId").val("");
				$('#txtLink').val("");
				$("#fileId").val("");
				$("#img").attr("src", "");
				$("#bannerInput").val("");
				$("#files").val("");
			}

			//删除banner
			function deleteBanner(othis) {
				var id = $(othis).parents('tr').find('.id-num').text();
				layer.confirm('确定删除id为"' + id + '"的图片吗？', {
					btn: ['Y', 'N']
				}, function() {
					delData(id);
				})
			}

			function sortDown(othis) {
				if($(othis).hasClass('disable')) {
					return;
				} else {
					var onNum = $(othis).parents('tr').find('.id-num').text();
					setSorting(onNum, "down");
				}
			}

			function sortUp(othis) {
				if($(othis).hasClass('disable')) {
					return;
				} else {
					var onNum = $(othis).parents('tr').find('.id-num').text();
					setSorting(onNum, "up");
				}
			}

			function setSorting(sSerialNo, flag) {
				$.ajax({
					type: "POST",
					url: "/api/DsWebsit/sortData.do",
					dataType: "json",
					data: {
						type: paramType,
						serailNo: sSerialNo,
						flag: flag
					},
					success: function(jsonResult) {
						layer.msg(jsonResult.message);
						getDatas();
					},
					error: function(XMLHttpRequest, textStatus, errorThrown) {
						layer.msg("系统异常，请稍后再试！");
					}
				});
			}

			function uploadImg() {
				var form = new FormData(document.getElementById("tf"));
				$.ajax({
					url: "/api/uploadImageLocal.do",
					async: false,
					type: "post",
					data: form,
					processData: false, // 告诉jQuery不要去处理发送的数据
					contentType: false, // 告诉jQuery不要去设置Content-Type请求头
					success: function(jsonResult) {
						console.log(jsonResult);
						if(jsonResult.code == "0000") {
							layer.msg("上传成功");
							$("#fileId").val(jsonResult.data);
							$("#img").attr("src", jsonResult.data);
						} else {
							layer.msg("上传失败");
						}
					},
					error: function(XMLHttpRequest, textStatus, errorThrown) {
						layer.msg("系统异常，请稍后再试！");
					}
				});
			}

			function addData(pos) {
				$.ajax({
					type: "POST",
					url: "/api/DsWebsit/addData.do",
					dataType: "json",
					data: {
						"pos": JSON.stringify(pos),
						type: paramType
					},
					success: function(jsonResult) {
						getDatas();
						closeDiv();
						layer.msg(jsonResult.message);
					},
					error: function(XMLHttpRequest, textStatus, errorThrown) {
						layer.msg("系统异常，请稍后再试！");
					}
				});
			}

			function getDatas() {
				$.ajax({
					type: "POST",
					url: "/api/DsWebsit/getDatas.do",
					data: {
						type: paramType,
						page: "0",
						size: "4"
					},
					dataType: "json",
					success: function(jsonResult) {
						console.log(jsonResult);
						if(jsonResult.code == "0000" && jsonResult.data.length > 0) {
							$("#list").empty();
							$.each(jsonResult.data, function(i, val) {

								var link = isEmpty(val.imageLink) ? "" : val.imageLink;
								var field1 = isEmpty(val.field1) ? "" : val.field1;
								if(i == 0) {
									/*<td>" + link + "</td> 外部链接*/
									$("#list").append("<tr><td><span class='id-num'>" + val.baseNo + "</span></td><td><img src='" + val.imageSrc + "' class='banners'></td><td>" + field1 + "</td>" +
										"<td><span class='sortIndex'>" + val.sortIndex + "</span></td><td><a class='sort-up sort  disable ' href='javascript:void(0)' onclick='sortUp(this)'><i class='glyphicon glyphicon-arrow-up'></i></a><a class='sort-down sort ' href='javascript:void(0)' onclick='sortDown(this)'><i class='glyphicon glyphicon-arrow-down'></i></a></td><td><a class='edit-btn' href='javascript:void(0)' onclick='editBanner(this)'>编辑</a><a class='delete-btn' href='javascript:void(0)' onclick='deleteBanner(this)'>删除</a></td></tr>");
								} else if(i > 0 && i == jsonResult.data.length - 1) {
									$("#list").append("<tr><td><span class='id-num'>" + val.baseNo + "</span></td><td><img src='" + val.imageSrc + "' class='banners'></td><td>" + field1 + "</td>" +
										"<td><span class='sortIndex'>" + val.sortIndex + "</span></td><td><a class='sort-up sort  ' href='javascript:void(0)' onclick='sortUp(this)'><i class='glyphicon glyphicon-arrow-up'></i></a><a class='sort-down sort  disable ' href='javascript:void(0)' onclick='sortDown(this)'><i class='glyphicon glyphicon-arrow-down'></i></a></td><td><a class='edit-btn' href='javascript:void(0)' onclick='editBanner(this)'>编辑</a><a class='delete-btn' href='javascript:void(0)' onclick='deleteBanner(this)'>删除</a></td></tr>");
								} else {
									$("#list").append("<tr><td><span class='id-num'>" + val.baseNo + "</span></td><td><img src='" + val.imageSrc + "' class='banners'></td><td>" + field1 + "</td>" +
										"<td><span class='sortIndex'>" + val.sortIndex + "</span></td><td><a class='sort-up sort ' href='javascript:void(0)' onclick='sortUp(this)'><i class='glyphicon glyphicon-arrow-up'></i></a><a class='sort-down sort ' href='javascript:void(0)' onclick='sortDown(this)'><i class='glyphicon glyphicon-arrow-down'></i></a></td><td><a class='edit-btn' href='javascript:void(0)' onclick='editBanner(this)'>编辑</a><a class='delete-btn' href='javascript:void(0)' onclick='deleteBanner(this)'>删除</a></td></tr>");
								}
							});
							if(jsonResult.data.length >= 4) {
								$("#create-btn").attr("disabled", "disabled");
								$("#create-btn").attr("style", "background:#ccc;border:none");
							} else {
								$("#create-btn").attr("disabled", false);
								$("#create-btn").attr("style", "");
							}
						} else {
							$("#list").html("");
						}
					},
					error: function(XMLHttpRequest, textStatus, errorThrown) {
						layer.msg("系统异常，请稍后再试！");
					}
				});
			}

			function editBanner(othis) {
				var id = $(othis).parents('tr').find('.id-num').text();
				$.ajax({
					type: "POST",
					url: "/api/DsWebsit/getData.do",
					data: {
						type: paramType,
						serailNo: id
					},
					dataType: "json",
					success: function(jsonResult) {
						console.log(jsonResult);
						if(jsonResult.code == "0000") {
							$("#hidId").val(id);
							$('#txtLink').val(jsonResult.data.imageLink);
							$("#img").attr("src", jsonResult.data.imageSrc);
							$('#layui-layer-shade-alert').show();
							$('#layui-layer-alert').show();

							/* 给级联选择赋值 */
							clearBtn();
							var pageTmp = jsonResult.data.field1.split("#")[0];
							var moduleTmp = jsonResult.data.field1.split("#")[1];
							if(pageTmp.length > 0){	//如果是内部链接就给父级赋值
								$("#selID option[value='" + pageTmp + "']").attr("selected", true);
								var index = $('#selID').get(0).selectedIndex;	//获取点的第几个
								var targetAnchor = moduleArr[index - 1].children;	//找到对应页面有哪些模块
								if(targetAnchor){ //如果该页面有子模块，生成子选择框
									$("<select id='subID' onchange='selSub()'></select>").insertAfter("#selID"); //插入子选择框
									for(var i = 0; i < targetAnchor.length; i++) {
										$("#subID").append("<option value='" + targetAnchor[i].anchorId + "'>" + targetAnchor[i].anchorName + "</option>");
									}
									if(moduleTmp){
										$("#subID option[value='" + moduleTmp + "']").attr("selected", true);
									}
								}
							}
						} else {
							layer.msg('获取数据失败');
						}
					},
					error: function(XMLHttpRequest, textStatus, errorThrown) {
						layer.msg("系统异常，请稍后再试！");
					}
				});
			}

			function delData(id) {
				$.ajax({
					type: "POST",
					url: "/api/DsWebsit/delData.do",
					data: {
						type: paramType,
						serailNo: id
					},
					dataType: "json",
					success: function(jsonResult) {
						if(jsonResult.code == "0000") {
							layer.msg(jsonResult.message);
							getDatas();
						} else {
							layer.msg('删除失败');
						}
					},
					error: function(XMLHttpRequest, textStatus, errorThrown) {
						layer.msg("系统异常，请稍后再试！");
					}
				});
			}
		</script>
	</body>

</html>

