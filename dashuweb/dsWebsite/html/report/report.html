<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="../../files/css/bootstrap.css">
    <link rel="stylesheet" href="../../files/css/font-awesome.min.css">
    <link rel="stylesheet" href="../../files/css/simple-line-icons.css">
    <link rel="stylesheet" href="../../files/css/bootstrap-datetimepicker.min.css">
    <link rel="stylesheet" href="../../files/css/app.css">
    <link rel="stylesheet" href="../../files/css/paltstyle.css">
    <title>Title</title>
</head>
<body style="background: none;">
 <input type="hidden" id="reportId">
<div class="widget-box">
    <div class="widget-title"> <span class="icon"><i class="glyphicon glyphicon-th"></i></span>
        <h5>媒体报道</h5>
    </div>
    <div class="widget-content ">
        <div class="operation text-right">
            <button id="create-btn" class="btn btn-info l-s-2x">新增</button>
        </div>
        <table class="table data-table table-bordered">
            <thead>
            <tr>
                <th style="display: none;">ID编号</th>
                <th style="min-width: 150px;">标题</th>
                <th style="min-width: 200px;">副标题</th>
                <th style="width: 80px;">作者</th>
                <th style="width: 120px;">报道类型</th>    
                <th style="width: 80px;">排序操作</th>
                <th style="width: 80px;">排序号</th>
                <th style="width: 80px;">显示状态</th>
                <th style="width: 100px;">发布时间</th>
                <th style="width: 100px;">操作</th>
            </tr>
            </thead>
            <tbody id="list">

            </tbody>
        </table>

        <div class="text-right">
            <ul class="pagination pagination-sm">
            </ul>
        </div>

    </div>

</div>
<div class="layui-layer-shade" id="layui-layer-shade11" times="1"
				style="display: none; z-index: 14; background-color: #000; opacity: 0.3; filter: alpha(opacity = 30);"></div>
			<div class="layui-layer layui-anim layui-layer-page "
				id="layui-layer11" type="page"
				style="display: none; z-index: 15; width: 960px; height: 500px; left: 50%; top: 50%; margin-left: -480px; margin-top: -250px;overflow-y: auto;overflow-x: auto;">
				<div class="layui-layer-content" style="height: 800px;">
				  
			  <div class="form-horizontal">
    <div class="double-input">
    
        <div class="l input-groups">
            <label>标题：</label>
            <input id="txtTitle" type="text" class="title" placeholder="请输入标题">
        </div>
        <div class="r input-groups">
            <label>副标题：</label>
            <input id="txtSubTitle" type="text" class="subTitle" maxlength="100" placeholder="请输入不超过100字的副标题">
        </div>
    </div>

    <div class="double-input">
       
         <div class="r input-groups">
            <label>作者：</label>
            <input id="newsAuthor" type="text" class="author" placeholder="请输入作者">
        </div>
        <div class="r input-groups" style="width: 300px">
            <label>发布时间：</label>
            <div class="input-append date" id="releaseTime" data-date="" data-date-format="dd-MM-yyyy">
                <input class="span2" size="16" type="text"  readonly>
                <span class="add-on"><i class="icon-th glyphicon glyphicon-calendar"></i></span>
            </div>
        </div>
    </div>
 <div class="double-input">
	 <div class="l input-groups">
            <label>封面：</label>
            <form id="tf">
            <input id="newsImg" type="text" class="file-input cover" placeholder="选择封面（图片的尺寸为：390*300px）">
            <div class="file-box">
                <input type="file" class="file" id="files" name="image" >                              
            </div>
            </form>
            <input type="hidden" id="fileId">
            <button id="add-btn" class="btn btn-info pull-left" onclick="uploadImg()">上传封面</button>
        </div>
         <div class="r input-groups">
            <label>封面预览：</label>
             <img src="" id="img" width="150px">
        </div>
         </div>
   <div class="double-input">
	    <div class="l input-groups">
	            <label>显示状态：</label>
	            <div class="checkbox-box"><input type="checkbox" id ="cbStatus1" class="status" name="show" checked="checked" value="2">显示</div>
	            <div class="checkbox-box"><input type="checkbox" id ="cbStatus2" class="status" name="notshow" value="1">不显示</div>
	    </div>
	    <div class="r input-groups">
           <label>报道类型：</label>
             	<select id="selReportType" style="height:41px">						 
				      <option value="1">荣誉</option>
				      <option value="2">报道</option>	
				      <option value="3">活动</option>	
				      				       
				</select>
        </div>
    </div>
     <div class="double-input">
         <div class="r input-groups">
            <label>关键字：</label>
            <input id="txtKeywords" type="text" class="author" placeholder="核心关键词1,核心关键词2,核心关键词3">
        </div>
    </div>
    <div class="input-groups  sel-input">
        <label>新闻内容：</label>
       <div>
           <iframe src="../../wysiwyg.html" id="content" frameborder="0" width="1000px" height="430px"></iframe>
       </div>
    </div>
    <div class="input-groups btns">
      <button id="close-btn" onclick="closeDiv()" class="btn btn-default pull-right">关闭</button>
        <button id="confirm-btn" class="btn btn-info pull-right" >确认</button>
        <!-- <button id="reset-btn" class="btn btn-default pull-right">重置</button> -->
      
    </div>

</div>
				</div>
				<span class="layui-layer-setwin"></span>
			</div>


<script src="../../files/js/jquery.min.js"></script>
<script src="../../files/js/bootstrap.js"></script>
<script src="../../files/js/bootstrap-datetimepicker.js"></script>
<script src="../../files/js/bootstrap-datetimepicker.zh-CN.js"></script>
<script src="../../files/layer/layer.js"></script>
<script src="../../files/js/comment.js"></script>
<script>
var reportTypeObj={"1":"荣誉","2":"报道","3":"活动"};  
    $(function(){
    	loadData(10,0);
     	//init();
        //时间选择器
        $('#releaseTime').datetimepicker({
            language:  'zh-CN',
            format: 'yyyy-mm-dd',
            startDate:'2014-01-01',
            weekStart: 1,  //一周从星期一开始。0（星期日）到6（星期六）
            todayBtn:  true,
            autoclose: 1,//当选择一个日期之后是否立即关闭此日期时间选择器。
            todayHighlight: true, //高亮显示今天的时间
            keyboardNavigation:true,
            startView: 2, //日期时间选择器打开之后首先显示的视图。0 or 'hour' for the hour view;1 or 'day' for the day view;2 or 'month' for month view (the default);3 or 'year' for the 12-month overview;4 or 'decade' for the 10-year overview.
            forceParse: 0,
            minView:2
        });

       $('#create-btn').click(function(){   
    	   var date = format1(new Date());
    	   $('#releaseTime input').val(date);
    	   $('#newsAuthor').val("");
	    	$('#txtTitle').val("");
	    	$('#txtSubTitle').val("");		 	 
     		$('#cbStatus1').prop('checked',true);
     		$('#cbStatus2').prop('checked',false);     		   		
			document.getElementById("content").contentWindow.document.getElementById("editor").innerHTML = "请输入...";
	      	$("#fileId").val("");
	    	$("#img").attr("src","");
	      	$('.file-input').val("");
    	   $('#layui-layer-shade11').show();
           $('#layui-layer11').show();
           $('#txtKeywords').val("");
       });
       $('#confirm-btn').click(function(){
    	  	  var id = $("#reportId").val();
    	  	  var author =  $('#newsAuthor').val();
    	  	  var title =  $('#txtTitle').val();
    	  	  var subTitle =  $('#txtSubTitle').val();
    	  	  var keywords =  $('#txtKeywords').val();
   		      var publishDate = $('#releaseTime input').val();
   		      var status = $('#cbStatus1').prop('checked')==true?"2":"1";  		   
   		   	  var reportType = $("#selReportType").val();
   			  var baseContent = document.getElementById("content").contentWindow.document.getElementById('editor').innerHTML;
   			  var description = baseContent;
   	    	  var imgSrc = "";
   	    	  var onPage=$('.pagination').find('.active').text()-1;  //新增的功能,获取当前页
    	    	  if(isEmpty($("#img").attr("src"))){
    	    		  imgSrc = $("#fileId").val();
    	    	  }else{
    	    		  imgSrc = $("#img").attr("src");
    	    	  }
    	    	  var pos = {'status': status,'imageSrc': imgSrc,baseContent:baseContent,publishDate:publishDate,title:title,author:author,subTitle:subTitle,reportType:reportType,keywords:keywords,description:description};
    	    
    	          if(isEmpty($('.title').val())){
    	              layer.msg('请输入标题');
    	              return;
    	          }
    	          if(!$("input[name='show']").is(':checked') && !$("input[name='notshow']").is(':checked')){
    	              layer.msg('请选择显示状态');
    	              return;
    	          }    	      
    	          var url = isEmpty(id)?"/api/DsWebsit/addData.do":"/api/DsWebsit/upData.do";   	        
    	         		$.ajax({
    	                  type:'post',
    	                  dataType:'json',
    	                  url : url,
    	                  data:{
    						pos:JSON.stringify(pos),
    	      				type : 'report',
    	      				serailNo : id
    	      			}, 
    	                  success : function(rtnData){
    	                  	layer.msg(rtnData.message);
    	                  	if(rtnData.code=="0000"){
    	                  	  	$('#layui-layer-shade11').hide();
    	      	            	$('#layui-layer11').hide();
    	      	            	$("#reportId").val("");
    	      	            	loadData(10,onPage);//新增功能,修改过后还是留在当前页
    	                  	}
    	                  },
    	       			error: function(XMLHttpRequest, textStatus, errorThrown) {
    	      				layer.msg("系统异常，请稍后再试！");
    	       			}
    	              }); 
    	         	
    	    });
       initEdit();
    });
    
    //下一页
	function nextPage(){
    	loadData(10,$('.pagination').find('.active').text());
    }
    //上一页
    function agaoPage(){
    	loadData(10,$('.pagination').find('.active').text()-2);
    }

    
    function sortDown(othis){
    	if($(othis).hasClass('disable')){
            return ;
        }else{
        	var onNum =  $(othis).parents('tr').find('.id-num').text();
            setSorting(onNum,"down");
        }
    }
    
    function sortUp(othis){
    	if($(othis).hasClass('disable')){
            return ;
        }else{
            var onNum =   $(othis).parents('tr').find('.id-num').text();
            setSorting(onNum,"up");
        }
    }
    function setSorting(sSerialNo,flag){
    	$.ajax({
			type : "POST",
			url : "/api/DsWebsit/sortData.do",
			dataType : "json",
			data : {
				type : 'report',
				serailNo : sSerialNo,
				flag : flag
			},
			success : function(jsonResult) {
				layer.msg(jsonResult.message);
				var nowPage = $('.pagination li.active a').text()-1;				 
				loadData(10,nowPage);
			},
			error: function(XMLHttpRequest, textStatus, errorThrown) {
				layer.msg("系统异常，请稍后再试！");
            }
		});
    }
    
    $(document).on('click','.pagination a',function(){
  	  var onPage = $(this).text()-1;
        loadData(10,onPage);
  });
    
    function closeLayer(){
        layer.closeAll();
    }
    function closeDiv(){
    	$("#reportId").val("");
      	$('#layui-layer-shade11').hide();
      	$('#layui-layer11').hide();
    }
    function page(totalPage,onPage){
    	$('.pagination').empty();
        if(onPage==0){
            $('.pagination').append('<li class="disabled "><a href="#">&laquo;</a></li>');
        }else{
            //$('.pagination').append('<li class="prev"><a href="#">&laquo;</a></li>');
			$('.pagination').append('<li class="prev"><a href="javascript:void(0); onclick=agaoPage()">&laquo;</a></li>');
        }

        for (var i=0;i<totalPage;i++){
            if(i==(onPage)){
                $('.pagination').append('<li class="active"><a href="#">'+ (i+1) +'</a></li>');
            }else{
                $('.pagination').append('<li><a>'+ (i+1) +'</a></li>');
            }

        }

        if(onPage==(totalPage-1)){
            $('.pagination').append('<li class="disabled"><a href="#">&raquo;</a></li>');
        }else{
           // $('.pagination').append('<li class="next"><a href="#">&raquo;</a></li>');
		   $('.pagination').append('<li class="next"><a href="javascript:void(0); onclick=nextPage()">&raquo;</a></li>');
        }

    }
    
    function setList(data,onPage,pageNumber){
    	$('#list').empty();
    	var disableUp = '', disableDown = '';
        for(var i=0;i<data.length;i++){
        	if(onPage==0 && i==0){
        		disableUp = 'disable';
        	}else{
        		disableUp = '';
        	}
        	if(onPage==(pageNumber-1) && i==data.length-1){
                disableDown =  'disable';
            }else{
                disableDown = '';
            }
        	var status = data[i].status=="2"?"显示":"不显示";
        	 
            $('#list').append(' <tr> <td style="display: none;"><span class="id-num">'+
                    data[i].baseNo +'</span></td> ' +
                    '<td>'+  data[i].title +'</td> ' +
                    '<td>'+  data[i].subTitle +'</td> ' +
                    '<td>'+  data[i].author +'</td> ' +
                    '<td>'+ reportTypeObj[data[i].reportType]+'</td> ' +  
                    '<td><a class="sort-up sort '+ disableUp +'" href="javascript:void(0)" onclick="sortUp(this)"><i class="glyphicon glyphicon-arrow-up"></i></a> ' +
                    '<a class="sort-down sort '+ disableDown +'"  href="javascript:void(0)" onclick="sortDown(this)"><i class="glyphicon glyphicon-arrow-down"></i></a></td> ' +
                    '<td "><span class="sort-num">'+  data[i].sortIndex +'</span></td> ' +
                    '<td>'+  status +'</td> ' +
                    '<td>'+  format1(data[i].publishDate) +'</td> ' +
                    '<td><a class="edit-btn" onclick="editData(\''+data[i].baseNo+'\')" href="javascript:void(0)">编辑</a> ' +
                    '<a class="delete-btn" onclick="deleteData(\''+data[i].baseNo+'\')" href="javascript:void(0)">删除</a></td> </tr>')
        }

    }

    
    function loadData(size,onPage){
    	var pageNumber = 0;
		$.ajax({
            type:'post',
            dataType:'json',
            url : '/api/DsWebsit/getDatas.do',
            data: {
                 page:onPage,
                 size:size,
                 type : "report"
            },
            success : function(rtnData){
            	if(rtnData.code=="0000"){
            		if(!isEmpty(rtnData.data)){
            			pageNumber = Math.ceil(rtnData.data.total/size);
                		setList(rtnData.data.list,onPage,pageNumber);               		
                		page(pageNumber,onPage);
            		}
            		
            	}
            }
        });
	}
    
    function editData(id){
    	$("#reportId").val(id);     
    	 $.ajax({
             type:'post',
             dataType:'json',
             url : '/api/DsWebsit/getData.do',
             data: {                    
            	  serailNo:id,
                  type : "report"
             },
             success : function(rtnData){
             	if(rtnData.code=="0000"){
             		if(!isEmpty(rtnData.data)){
             			$('#newsAuthor').val(rtnData.data.author);
             	    	$('#txtTitle').val(rtnData.data.title);
             	    	$('#txtSubTitle').val(rtnData.data.subTitle);
             	    	$('#txtKeywords').val(rtnData.data.keywords);
             	   		$('#selReportType').val(rtnData.data.reportType);
             	   	 	$('#releaseTime input').val(format1(rtnData.data.publishDate));
             		    var imgSrc= rtnData.data.imageSrc;
             		    $("#img").attr("src",imgSrc);            		    
             			$("#fileId").val(imgSrc.substr(imgSrc.indexOf("=")+1));
             			$('.file-input').val("");
             		   $("input.status:checked").val(rtnData.data.status);
             			 if(rtnData.data.status=='2'){
                  			$('#cbStatus1').prop('checked',true);
                  			$('#cbStatus2').prop('checked',false);
                  		}else{
                  			$('#cbStatus1').prop('checked',false);
                  			$('#cbStatus2').prop('checked',true);
                  		}      		
             			document.getElementById("content").contentWindow.document.getElementById("editor").innerHTML = rtnData.data.baseContent;
             	      	$("#fileId").val(rtnData.data.imageSrc);
             	       $('#layui-layer-shade11').show();
                       $('#layui-layer11').show();
             		}
             		
             	}
             }
         });
   }
   
    function deleteData(id){
    	layer.confirm('确定删除该条媒体报道吗？',{
            btn:['Y','N']
        },function(){
        	$.ajax({
                type:'post',
                dataType:'json',
                url : '/api/DsWebsit/delData.do',
                data:{
					type : "report",
    	        	serailNo : id
    	        }, 
                success : function(rtnData){
                	layer.msg(rtnData.message);
                	if(rtnData.code=="0000"){
                		window.location.reload();
                	}
                }
            });
           
        })
    }
    function uploadImg(){
		var form = new FormData(document.getElementById("tf"));
		$.ajax({
		    url:"/api/uploadImageLocal.do",
		    async: false,
		    type:"post",
		    data: form,
		    processData: false,  // 告诉jQuery不要去处理发送的数据
		    contentType: false,  // 告诉jQuery不要去设置Content-Type请求头
		    success:function(jsonResult){
		    	if(jsonResult.code == "0000"){
		    		layer.msg("上传成功");
		    		$("#fileId").val(jsonResult.data);	
		    		$("#img").attr("src",jsonResult.data); 
		    	} else {
		    		layer.msg("上传失败");
		    	}
 			},
 			error: function(XMLHttpRequest, textStatus, errorThrown) {
				layer.msg("系统异常，请稍后再试！");
          }
		});
	}
    function initEdit(){   	 
        //封面选择事件
        $('.file-box .file').change(function(){
            $('.file-input').val($(this).val());
        });

        //状态选择事件
        $('.status').click(function(){
            $(this).parent().siblings().find('.status').prop('checked',false);
        });

    }
</script>
</body>
</html>